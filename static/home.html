{{define "body"}}
<div class="scroll-progress" id="scrollProgress"></div>

<header class="header">
  <div>
    <h1>The Atlas of Appetite</h1>
    <p class="header-subtitle">A Culinary Journey Through Global BMI</p>
  </div>
</header>

<main class="gallery-wrapper">
  <div class="gallery" style="--num-cols: {{.NumCols}}; --num-rows: {{.NumRows}};">
    {{range .Cards}}
    <article class="card" style="--grid-row: {{.GridRow}}; --grid-col: {{.GridCol}}; --order: {{.Order}};">
      <div class="image-frame">
        <div class="vignette"></div>
        <img
          data-src="https://pub-488a9578ab1844a5a92b26e9a82d4a8d.r2.dev/{{.ImageLink}}"
          alt="National dish of {{.Country}}"
          loading="lazy"
        />
        <div class="bmi-badge">{{printf "%.1f" .Both}}</div>
      </div>
      
      <div class="card-info">
        <h2 class="country">{{.Country}}</h2>
        {{if .NationalDish}}
        <a class="dish" href="{{.DishWiki}}" target="_blank" rel="noopener noreferrer">
          {{.NationalDish}}
        </a>
        {{end}}
      </div>
    </article>
    {{end}}
  </div>
</main>

<script>
  const scrollProgress = document.getElementById('scrollProgress');
  
  function updateScrollProgress() {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrollPercent = (scrollTop / docHeight) * 100;
    scrollProgress.style.height = scrollPercent + '%';
  }
  
  window.addEventListener('scroll', updateScrollProgress, { passive: true });

  const images = document.querySelectorAll('img[data-src]');
  const imageFrames = document.querySelectorAll('.image-frame');
  
  imageFrames.forEach(frame => frame.classList.add('loading'));

  const imageObserver = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const img = entry.target;
          const frame = img.closest('.image-frame');
          
          img.onload = () => frame.classList.remove('loading');
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
          obs.unobserve(img);
        }
      });
    },
    { rootMargin: '200px' }
  );

  images.forEach((img) => imageObserver.observe(img));

  const cards = document.querySelectorAll('.card');
  
  const revealObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('revealed');
          revealObserver.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.1, rootMargin: '0px 0px -30px 0px' }
  );

  cards.forEach((card) => revealObserver.observe(card));
</script>
{{end}}